<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Expediente de <%= nino.nombre_completo %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="/css/postulaciones.css" rel="stylesheet"> <link href="/css/navbarStyles.css" rel="stylesheet">
  <style>
    /* Estilos para el encabezado del perfil */
    .profile-photo {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover; /* Asegura que la imagen no se deforme */
      border: 4px solid #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .profile-header {
      background-color: #f8f9fa;
      padding: 2rem;
      border-radius: 12px;
    }
    /* Estilo para la foto pequeña del año */
    .year-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #dee2e6;
    }
  </style>
</head>
<body>
  <%- include('navbar') %>

  <div class="container mt-5">
    <div class="main-card">

      <div class="profile-header row align-items-center mb-4">
        <div class="col-md-3 text-center">
            <img src="/<%= expedienteDelAnio.foto_url ? expedienteDelAnio.foto_url.replace('public/', '') : 'uploads/default_nino.png' %>" class="profile-photo" alt="Foto del año <%= anioSeleccionado %>">
        </div>
        <div class="col-md-9">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h2 class="mb-1"><%= nino.nombre_completo %></h2>
              <p class="text-muted mb-2">Código FUNDAL: <strong><%= nino.codigo %></strong></p>
              <span class="badge bg-primary fs-6"><%= nino.etapa %></span>
            </div>
            <a href="/expedientes" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Volver a Expedientes</a>
          </div>
        </div>
      </div>

      <% if (success_msg && success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= success_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>
      <% if (error_msg && error_msg.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= error_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <ul class="nav nav-tabs mb-4" id="expedienteTabs" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="datos-tab" data-bs-toggle="tab" data-bs-target="#datos">Datos Generales</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="anual-tab" data-bs-toggle="tab" data-bs-target="#anual">Expedientes Anuales</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="representantes-tab" data-bs-toggle="tab" data-bs-target="#representantes">Representante y Auxiliar</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos">Documentos</button></li>
      </ul>

      <div class="tab-content" id="expedienteTabsContent">

        <div class="tab-pane fade show active" id="datos" role="tabpanel">
          <div class="card"><div class="card-body">
            <h5 class="card-title mb-3">Información Personal</h5>
            <div class="row">
              <div class="col-md-4"><p><strong>Fecha de Nacimiento:</strong> <%= nino.fecha_nacimiento ? new Date(nino.fecha_nacimiento).toLocaleDateString('es-GT') : 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Edad Actual:</strong> <%= nino.edad || 'N/A' %> años</p></div>
              <div class="col-md-4"><p><strong>Género:</strong> <%= nino.genero || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>ID Partida Nacimiento:</strong> <%= nino.id_partida_nacimiento || 'N/A' %></p></div>
            </div>
            <hr>
            <h5 class="card-title mt-4 mb-3">Ubicación y Origen</h5>
            <div class="row">
              <div class="col-md-4"><p><strong>Departamento:</strong> <%= nino.departamento || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Municipio:</strong> <%= nino.municipio || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Aldea/Comunidad:</strong> <%= nino.aldea || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Sede:</strong> <%= nino.sede || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Referido por:</strong> <%= nino.referido_por || 'N/A' %></p></div>
            </div>
            <hr>
            <h5 class="card-title mt-4 mb-3">Información Médica y Administrativa</h5>
            <div class="row">
              <div class="col-md-4"><p><strong>Código MINEDUC:</strong> <%= nino.codigo_mineduc || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Dificultad Socioeconómica:</strong> <%= nino.dificultad_socioeconomica || 'N/A' %></p></div>
              <div class="col-12"><p><strong>Diagnóstico:</strong> <%= nino.diagnostico || 'N/A' %></p></div>
              <div class="col-12"><p><strong>Discapacidad:</strong> <%= nino.discapacidad || 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Fecha de Evaluación:</strong> <%= nino.fecha_evaluacion ? new Date(nino.fecha_evaluacion).toLocaleDateString('es-GT') : 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Fecha Ingreso a Fundal:</strong> <%= nino.fecha_ingreso_fundal ? new Date(nino.fecha_ingreso_fundal).toLocaleDateString('es-GT') : 'N/A' %></p></div>
              <div class="col-md-4"><p><strong>Fecha Ingreso MSPAS:</strong> <%= nino.fecha_ingreso_mspas ? new Date(nino.fecha_ingreso_mspas).toLocaleDateString('es-GT') : 'N/A' %></p></div>
            </div>
            <div class="d-flex justify-content-end mt-3"><a href="/expedientes/editar/<%= nino.id %>" class="btn btn-warning">✏️ Editar Datos Generales</a></div>
          </div></div>
        </div>

        <div class="tab-pane fade" id="anual" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <label for="anioSeleccion" class="form-label me-2 mb-0">Año Escolar:</label>
                <select id="anioSeleccion" class="form-select w-auto" onchange="window.location.href = this.value">
                  <% expedientesAnuales.forEach(exp => { %>
                    <option value="/expedientes/<%= nino.id %>/<%= exp.anio %>" <%= (anioSeleccionado == exp.anio) ? 'selected' : '' %>><%= exp.anio %></option>
                  <% }) %>
                  <% if (expedientesAnuales.length === 0) { %>
                    <option selected disabled>No hay años</option>
                  <% } %>
                </select>
              </div>
              <a href="/expedientes/<%= nino.id %>/revision-anual" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Realizar Reinscripción Anual
              </a>
            </div>
            <div class="card-body">
              <% if (expedienteDelAnio) { %>
                <h5 class="card-title mb-4">Detalles del Año <%= anioSeleccionado %></h5>
                <div class="row">
                  <div class="col-md-9">
                    <div class="row">
                      <div class="col-md-6 mb-3"><small class="text-muted d-block">Grado</small><p class="fw-bold fs-5 mb-0"><%= expedienteDelAnio.grado || 'N/A' %></p></div>
                      <div class="col-md-6 mb-3"><small class="text-muted d-block">Programa Asignado</small><p class="fw-bold fs-5 mb-0"><%= expedienteDelAnio.programa_asignado || 'N/A' %></p></div>
                      <div class="col-md-12 mb-3"><small class="text-muted d-block">Docentes Asignados</small><p class="fw-bold fs-5 mb-0"><%= expedienteDelAnio.docentes_asignados || 'N/A' %></p></div>
                      <div class="col-12 mt-2"><small class="text-muted d-block">Observaciones</small><div class="p-3 bg-light rounded mt-1"><p class="mb-0"><%- expedienteDelAnio.observaciones ? expedienteDelAnio.observaciones.replace(/\n/g, '<br>') : 'N/A' %></p></div></div>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <div class="alert alert-warning">No hay información registrada para el año <%= anioSeleccionado %>.</div>
              <% } %>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="representantes" role="tabpanel">
           <% if (representantes && representantes.length > 0) { %>
            <% representantes.forEach(r => { %>
              <div class="card mb-3">
                <div class="card-header"><h5 class="mb-0">Representante Legal</h5></div>
                <div class="card-body">
                  <p><strong>Nombre:</strong> <%= r.nombre %></p>
                  <p><strong>DPI:</strong> <%= r.dpi || 'N/A' %></p>
                  <p><strong>Estado Civil:</strong> <%= r.estado_civil || 'N/A' %></p>
                  <p><strong>Parentesco:</strong> <%= r.parentesco || 'N/A' %></p>
                  <p><strong>Teléfono:</strong> <%= r.telefono || 'N/A' %></p>
                  <p><strong>Dirección:</strong> <%= r.direccion || 'N/A' %></p>
                </div>
              </div>
              <% if(r.auxiliar_nombre) { %>
                <div class="card">
                  <div class="card-header"><h5 class="mb-0">Auxiliar</h5></div>
                  <div class="card-body">
                    <p><strong>Nombre:</strong> <%= r.auxiliar_nombre %></p>
                    <p><strong>Teléfono:</strong> <%= r.auxiliar_telefono || 'N/A' %></p>
                  </div>
                </div>
              <% } %>
            <% }) %>
          <% } else { %>
            <div class="alert alert-info">No hay representantes legales registrados.</div>
          <% } %>
        </div>

        <div class="tab-pane fade" id="documentos" role="tabpanel">
          <div class="card">
            <div class="card-header"><h5 class="mb-0">Checklist de Documentos del Año <%= anioSeleccionado %></h5></div>
            <div class="card-body">
              <% if (documentos && documentos.length > 0) { %>
                <div class="row">
                  <% documentos.forEach(d => { %>
                    <div class="col-md-6 mb-2">
                      <div class="d-flex align-items-center">
                        <% if (d.confirmado) { %>
                          <i class="fas fa-check-circle text-success me-2 fs-5"></i>
                          <span><%= d.tipo %></span>
                        <% } else { %>
                          <i class="fas fa-times-circle text-danger me-2 fs-5"></i>
                          <span class="text-muted"><%= d.tipo %></span>
                        <% } %>
                      </div>
                    </div>
                  <% }) %>
                </div>
              <% } else { %>
                <div class="alert alert-info">No hay checklist de documentos para este año.</div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>